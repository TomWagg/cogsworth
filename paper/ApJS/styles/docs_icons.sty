% This is adapted from ShowYourWork! https://show-your.work/en/latest/

% Imports
\RequirePackage{mathtools} % equation tags
\RequirePackage{xcolor} % custom colors
\RequirePackage{hyperref} % url links
\RequirePackage{suffix} % allows definition of starred commmands
\RequirePackage{ifxetex}
\RequirePackage{fontawesome5} % FontAwesome symbols
\RequirePackage{letltxmacro} % command redefinitions
\RequirePackage{xstring} % string manipulation
\RequirePackage{catchfile} % read file into macro
\RequirePackage{totcount} % count total number of errors
\RequirePackage[notref, notcite]{showkeys} % get label refs
\RequirePackage{marginnote} % margin notes
\RequirePackage{xspace} % better spacing after icons
\RequirePackage{graphicx} % includegraphics
\RequirePackage{stackengine} % stacking figure links

% Custom margin icon
\newcommand\marginicon[1]{
  \renewcommand\showkeyslabelformat[1]{#1}%
}

% Key-value pairs used to assemble the hyperlinks for figures
% See https://tex.stackexchange.com/a/48931
\def\addDocsIcon#1#2{\expandafter\gdef\csname \detokenize{#1}\endcsname{#2}}
\def\usevalue#1{%
\ifcsname #1\endcsname%
  \csname #1\expandafter\endcsname%
\else%
  KEYNOTFOUND%
\fi%
}

% Add a GitHub link to the end of the abstract
\definecolor{codecolour}{HTML}{905cc4}

\let\oldabstract\abstract
\let\oldendabstract\endabstract
\renewenvironment{abstract}{%
  \oldabstract%
}{%
  % AASTex631 hack to reduce margin separation
  % in the abstract of a two-column document
  \ifcsname if@two@col\endcsname%
  \if@two@col\setlength{\marginparsep}{-25pt}\fi%
  \fi%
  \marginnote{%
    \href{https://github.com/TomWagg/cogsworth}{%
      \color{codecolour}%
      \faGithub%
    }%
      \hspace{3pt}%
      \href{https://cogsworth.readthedocs.io/en/latest/}{%
        \color{codecolour}
        \faBook%
      }%
  }
  \oldendabstract%
}


% Hack `showkeys' to show margin links for figures
% See https://tex.stackexchange.com/a/580553
\renewcommand\showkeyslabelformat[1]{%
  \normalfont%
    \IfEq*{\usevalue{#1}}{KEYNOTFOUND}{}{%
      \raisebox{0pt}[5pt][5pt]{%
        \href{\usevalue{#1}}{%
          \color{codecolour}\faLaptopCode%
        }%
      }%
    }%
}